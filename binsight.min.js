var InsApmBi={appId:"",postUrl:"http://tag.xinshangmeng.com/v2",addListener:function(c,b,a){if(c.addEventListener){c.addEventListener(b,a,false)}else{if(c.attachEvent){c.attachEvent("on"+b,a)}}},str2Byte:function(d){if(!d){return 0}var a=d.length,b=0;for(var c=0;c<a;c++){d.charCodeAt(c)>255?b+=2:b+=1}return b},clearUrlParam:function(b){if(!b){return null}var c=b.split("?");var d=c[1];if(d&&d.indexOf("method")==0){var a=c[0]+"/"+d.split("&")[0].split("=")[1];return a.substring(a.length-255)}else{return c[0].substring(c[0].length-255)}},post_data:function(a,c){var b=function(){APM_SENDER.corsSend(a,c)};if(window.setImmediate){window.setImmediate(b)}else{if(window.msSetImmediate){window.msSetImmediate(b)}else{if(window.webkitSetImmediate){window.webkitSetImmediate(b)}else{if(window.mozSetImmediate){window.mozSetImmediate(b)}else{setTimeout(b,10)}}}}}};var APM_SENDER={is_complete:true,corsSend:function(b,f){try{var d=new XMLHttpRequest();if(!"withCredentials" in d){d=XDomainRequest()}if(!d){return}d.open("POST",b,true);if("setRequestHeader" in d){d.setRequestHeader("Content-type","application/x-www-form-urlencoded")}d.send(a(f));d.onload=function(){if("console" in window){console.log(d.responseText)}}}catch(c){if("console" in window){console.log(c)}}function a(j){var e=[];var h=null;for(h in j){if(j.hasOwnProperty(h)){var i=Object.prototype.toString.call(j[h]);var g="";if(i==="[object Array]"||i==="[object Object]"){g=(j[h]===undefined||j[h]===null?"":encodeURIComponent(JSON.stringify(j[h])))}else{g=(j[h]===undefined||j[h]===null?"":encodeURIComponent(j[h]))}e.push(h+"="+g)}}if(e.length>0){return e.join("&")}return null}},sendData:function(d,h){if(!this.is_complete){setTimeout("sendData("+d+","+h+")",1000)}this.is_complete=false;var f=document.createElement("form");f.method="POST";f.id="beacon_form";f.enctype="application/x-www-form-urlencoded";var c=null;for(c in h){if(h.hasOwnProperty(c)){var b=document.createElement("input");b.type="hidden";b.name=c;var e=Object.prototype.toString.call(h[c]);if(e==="[object Array]"||e==="[object Object]"){b.value=(h[c]===undefined||h[c]===null?"":encodeURIComponent(JSON.stringify(h[c])))}else{b.value=(h[c]===undefined||h[c]===null?"":encodeURIComponent(h[c]))}f.appendChild(b)}}function a(j){var i=document.getElementById(j);if(i){i.parentNode.removeChild(i)}}function g(){var k,j="insapm_post-"+encodeURIComponent(f.action)+"-"+Math.random();try{k=document.createElement('<iframe name="'+j+'">')}catch(l){k=document.createElement("iframe")}f.action=d;k.name=k.id=j;k.style.display=f.style.display="none";k.src="javascript:false";a(k.id);a(f.id);if(document.body){document.body.appendChild(k)}var i=(k.contentWindow||k.contentDocument);if(i.document){i=i.document}if(i.body){i.body.appendChild(f)}else{i.appendChild(f)}try{f.submit()}catch(l){alert(l)}setTimeout(function(){a(k.id);this.is_complete=true},500)}g()}};(function(){if(!"performance" in window||!"timing" in window.performance){return}var i=INS_APM&&"info" in INS_APM&&"appId" in INS_APM.info?INS_APM.info.appId:"";if(!i&&i==""){return}var c=a();var j=decodeURI(window.location.search);var h=window.location.pathname+(j&&j.indexOf("?method=")>-1?"/"+j.substring(8,(j.indexOf("&")>-1?j.indexOf("&"):j.length)):"");var g={domain:document.domain,pageUrl:h.substring(h.length-255)};d();function d(){InsApmBi.addListener(document,"readystatechange",function(){if(g.pageUrl.indexOf("/apm/collector")>-1){return}if(document.readyState=="complete"){b()}});f();e()}function b(){var m={};var l=[];if("performance" in window&&"timing" in window.performance){var r=window.performance.timing;m.start=r.navigationStart;m.total=(r.loadEventEnd==0?r.domComplete:r.loadEventEnd)-r.navigationStart;m.redirect=r.redirectEnd-r.redirectStart;m.cache=r.domainLookupStart-r.fetchStart;m.dns=r.domainLookupEnd-r.domainLookupStart;m.connect=r.connectEnd-r.connectStart;m.request=r.responseStart-(r.secureConnectionStart?r.secureConnectionStart:r.requestStart);m.response=r.responseEnd==0?0:(r.responseEnd-r.responseStart);m.domParse=r.domInteractive-r.domLoading;m.domContent=r.domContentLoadedEventEnd-r.domContentLoadedEventStart;m.domDraw=r.domComplete-r.domContentLoadedEventEnd;m.loadEvent=r.loadEventEnd-r.loadEventStart;var k=window.performance.navigation;m.redirectCount=k.redirectCount;m.loadType=k.type;if("getEntries" in window.performance){var n=window.performance.getEntriesByType("resource");if(n.length>1){n.sort(function(t,s){return t.duration>s.duration?-1:1})}n=n.slice(0,10);for(var q=0;q<n.length;q++){if(n[q].name.indexOf(InsApmBi.postUrl)>-1){continue}var p=InsApmBi.clearUrlParam(n[q].name);p=p.indexOf("http")==0?p.substring(p.indexOf("//")+2):p;l.push({name:p,indicatorType:n[q].initiatorType,total:Math.round(n[q].duration)})}}}if(m&&m.start){var o=InsApmBi.postUrl+"/ppf.gif";InsApmBi.post_data(o,{appId:i,clientInfo:c,page:g,perf:m,entries:l,clientTime:(new Date()).getTime()})}}function a(){var m=window.navigator.userAgent;var o=l(m);var n=k(m);return{scrWidth:window.screen.width,scrHeight:window.screen.height,browser_name:o.browser_name,browser_version:o.browser_version,os_name:n.os_name,os_version:n.os_version};function l(p){var q;if((q=p.match(/rv:([\d.]+)\) like gecko/i))){return{browser_name:"MSIE",browser_version:q[1]}}else{var r=p.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\d+)/i)||[];if(r.length>=3){return{browser_name:r[1],browser_version:r[2]}}else{return{browser_name:"Other",browser_version:""}}}}function k(q){var p=navigator.platform;var s="";var r="";if(p=="Win32"||p=="Win64"||p=="Windows"){s="Windows";if(q.indexOf("Windows NT 5.1")>-1||q.indexOf("Windows XP")>-1){r="XP"}else{if(q.indexOf("Windows NT 5.2")>-1||q.indexOf("Windows 2003")>-1){r="2003"}else{if(q.indexOf("Windows NT 6.0")>-1||q.indexOf("Windows Vista")>-1){r="Vista"}else{if(q.indexOf("Windows NT 6.1")>-1||q.indexOf("Windows 7")>-1){r="7"}else{if(q.indexOf("Windows NT 6.2")>-1||q.indexOf("Windows 8")>-1){r="8"}else{if(q.indexOf("Windows NT 6.3")>-1||q.indexOf("Windows 8.1")>-1){r="8.1"}else{if(q.indexOf("Windows NT 10")>-1||q.indexOf("Windows 10")>-1){r="10"}else{r="Other"}}}}}}}}else{if(q.indexOf("Mac")>-1){s="Mac Os"}else{if(p.indexOf("X11")>-1){s="Unix"}else{if(p.indexOf("Linux")>-1){s="Linux"}else{s="Other"}}}}return{os_name:s,os_version:r}}}function f(){var k=window.XMLHttpRequest;window.XMLHttpRequest=function(m){var l=new k(m);var n=(""+Math.random()).replace(".","");l["startTime"+n]=0;l["endTime"+n]=0;l["open_url"]="";if(k.prototype.addEventListener){l.open=function(o,q,p){l["open_url"]=q;k.prototype.open.apply(this,arguments)};l.addEventListener("readystatechange",function(){if(!l["open_url"]||l["open_url"]==""||(l["open_url"]&&l["open_url"].indexOf(InsApmBi.postUrl)>-1)){return false}var r=l.readyState;if(r==0){l["startTime"+n]=new Date().getTime()}if(r==1){l["startTime"+n]=l["startTime"+n]==0?new Date().getTime():l["startTime"+n]}if(r==2){l["startTime"+n]=l["startTime"+n]==0?new Date().getTime():l["startTime"+n]}if(r==3){l["startTime"+n]=l["startTime"+n]==0?new Date().getTime():l["startTime"+n]}if(r==4){l["endTime"+n]=new Date().getTime();var p=InsApmBi.clearUrlParam(decodeURI(l["open_url"]));var q={respUrl:p,times:l["endTime"+n]-l["startTime"+n],statusCode:l.status,recBytes:InsApmBi.str2Byte(l.responseText)};if(p&&p!=undefined&&p!=""){var o=InsApmBi.postUrl+"/xhr.gif";InsApmBi.post_data(o,{appId:i,clientInfo:c,page:g,xhr:q,clientTime:(new Date()).getTime()})}}},false)}return l};window.XMLHttpRequest.prototype=k.prototype}function e(){window.onerror=function(n,p,o,m){var l={};if(typeof n=="string"&&typeof p=="string"){l.error_file=InsApmBi.clearUrlParam(p);l.error_line=o;l.error_msg=n.substring(n.length-255)}else{if(typeof p=="object"&&p.ajax){p=p.ajax.url;l.error_file=InsApmBi.clearUrlParam(p);l.error_line=o;l.error_msg=JSON.stringify(n).substring(n.length-255)}}if(l&&l.error_file){var k=InsApmBi.postUrl+"/jse.gif";InsApmBi.post_data(k,{appId:i,clientInfo:c,page:g,jserror:l,clientTime:(new Date()).getTime()})}}}})();
